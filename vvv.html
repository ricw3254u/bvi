<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador GPS Simplificado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sending-indicator::after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: #4a5568; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 #4a5568, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 #4a5568, .5em 0 0 #4a5568; }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-4xl mx-auto p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Rastreador GPS P√∫blico üõ∞Ô∏è</h1>
                <p class="text-gray-600 mt-2">Cualquier visitante puede enviar su ubicaci√≥n a nuestra hoja de c√°lculo centralizada.</p>
            </div>
            
            <div class="text-center mb-8">
                <button id="trackingButton" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                    Compartir mi Ubicaci√≥n
                </button>
                <div id="status" class="mt-4 text-gray-600 font-medium h-6">Esperando inicio...</div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-xl text-center">üìç Ubicaciones Registradas</h2>
                    <button id="refreshButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition text-sm">
                        Actualizar
                    </button>
                </div>
                <div class="overflow-x-auto bg-white rounded-lg shadow border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Timestamp</th>
                                <th scope="col" class="px-6 py-3">Latitud</th>
                                <th scope="col" class="px-6 py-3">Longitud</th>
                            </tr>
                        </thead>
                        <tbody id="locationsTableBody">
                           <tr><td colspan="3" class="text-center p-6 text-gray-500">A√∫n no hay datos.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- MEJORA: La URL ahora est√° directamente en el c√≥digo ---
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyGla2s5X8hz134G2-ysSgMRm7TirQQZHBPx_16QcMY7SlQSOqfrY7LIJLqqPfqhg1VnA/exec';

            const trackingButton = document.getElementById('trackingButton');
            const refreshButton = document.getElementById('refreshButton');
            const statusDiv = document.getElementById('status');
            const tableBody = document.getElementById('locationsTableBody');
            let watchId = null;

            // Cargar las ubicaciones existentes al abrir la p√°gina
            loadLocations();
            
            refreshButton.addEventListener('click', loadLocations);

            trackingButton.addEventListener('click', () => {
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                    trackingButton.textContent = 'Compartir mi Ubicaci√≥n';
                    trackingButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    trackingButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    statusDiv.textContent = 'Rastreo detenido.';
                    statusDiv.classList.remove('sending-indicator');
                } else {
                    if (!navigator.geolocation) {
                        statusDiv.textContent = 'La geolocalizaci√≥n no es soportada por tu navegador.';
                        return;
                    }
                    const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                    watchId = navigator.geolocation.watchPosition(handleSuccess, handleError, options);
                    trackingButton.textContent = 'Dejar de Compartir';
                    trackingButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    trackingButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    statusDiv.textContent = 'Buscando se√±al GPS...';
                }
            });

            async function handleSuccess(position) {
                const { latitude, longitude } = position.coords;
                statusDiv.textContent = `Enviando ubicaci√≥n...`;
                statusDiv.classList.add('sending-indicator');

                const lat = latitude.toFixed(6);
                const lon = longitude.toFixed(6);
                
                const urlWithParams = `${APPS_SCRIPT_URL}?latitude=${lat}&longitude=${lon}`;

                try {
                    const response = await fetch(urlWithParams);
                    const result = await response.json();

                    if (result.status !== 'success') {
                        throw new Error(result.message || 'El script devolvi√≥ un error.');
                    }
                    
                    statusDiv.textContent = `Ubicaci√≥n enviada.`;
                    statusDiv.classList.remove('sending-indicator');
                    
                    await loadLocations();

                } catch (error) {
                    console.error('Error al enviar ubicaci√≥n:', error);
                    statusDiv.textContent = 'Error al enviar la ubicaci√≥n. Revisa la consola.';
                    statusDiv.classList.remove('sending-indicator');
                }
            }
            
            function handleError(error) {
                console.warn(`ERROR(${error.code}): ${error.message}`);
                statusDiv.textContent = `Error de GPS: ${error.message}`;
            }

            async function loadLocations() {
                statusDiv.textContent = 'Actualizando lista...';

                try {
                    const response = await fetch(APPS_SCRIPT_URL);
                    if (!response.ok) throw new Error('No se pudo obtener la data.');
                    
                    const locations = await response.json();
                    
                    tableBody.innerHTML = ''; 
                    if (locations.length === 0) {
                         tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-6 text-gray-500">A√∫n no hay datos.</td></tr>';
                    } else {
                        locations.reverse().forEach(loc => {
                            const tr = document.createElement('tr');
                            tr.className = 'bg-white border-b hover:bg-gray-50';
                            tr.innerHTML = `
                                <td class="px-6 py-4">${loc.timestamp || 'N/A'}</td>
                                <td class="px-6 py-4">${loc.latitude || 'N/A'}</td>
                                <td class="px-6 py-4">${loc.longitude || 'N/A'}</td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    }
                    statusDiv.textContent = 'Lista actualizada.';
                } catch (error) {
                    console.error('Error al cargar ubicaciones:', error);
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-6 text-red-500">Error al cargar los datos.</td></tr>';
                    statusDiv.textContent = 'Error al cargar datos.';
                }
            }
        });
    </script>
</body>
</html>
